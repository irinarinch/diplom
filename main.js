!function(){"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const a=document.createElement("div");a.classList.add("cell","map-tile","map-tile-"+(t=e,s=this.boardSize,0===t?"top-left":t===s-1?"top-right":t===s**2-s?"bottom-left":t===s**2-1?"bottom-right":t<s?"top":t>s**2-s?"bottom":t%s==0?"left":t%s==s-1?"right":"center")),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}var t,s;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=s.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${s.character.health}%`,i.appendChild(r),a.appendChild(i),e.appendChild(a)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((s=>{const a=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",(()=>{a.removeChild(i),s()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class t{static from(e){return this.state={},this.state.positionedCharacters=e.positionedCharacters,this.state.userSelected=e.userSelected,this.state.computerSelected=e.computerSelected,this.state.points=e.points,this.state.level=e.level,this.state.activePlayer=e.activePlayer,this.state}static print(){if(void 0===this.state)this.maxPoints=0;else if(this.state.points>=this.maxPoints)this.maxPoints=this.state.points;else if(this.state.points<this.maxPoints)return this.maxPoints;return this.maxPoints}}var s={1:"prairie",2:"desert",3:"arctic",4:"mountain"};class a{constructor(e,t="generic"){function s(e){this.message=e,this.name="–ò—Å–∫–ª—é—á–µ–Ω–∏–µ, –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"}if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,e<1||e>4||"number"!=typeof e)throw new s("Incorrect level number");if("Character"===new.target.name)throw new s("You can't create base character")}}class i extends a{constructor(e){super(e),this.type="bowman",this.attack=30,this.defence=15,this.distance=2,this.attackRange=2}}class r extends a{constructor(e){super(e),this.type="swordsman",this.attack=40,this.defence=10,this.distance=4,this.attackRange=1}}class h extends a{constructor(e){super(e),this.type="magician",this.attack=25,this.defence=20,this.distance=1,this.attackRange=4}}class c extends a{constructor(e){super(e),this.type="daemon",this.attack=25,this.defence=10,this.distance=1,this.attackRange=4}}class o extends a{constructor(e){super(e),this.type="undead",this.attack=40,this.defence=10,this.distance=4,this.attackRange=1}}class l extends a{constructor(e){super(e),this.type="vampire",this.attack=30,this.defence=10,this.distance=2,this.attackRange=2}}class n{constructor(e,t){if(!(e instanceof a))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class d{constructor(e){this.characters=e}}function*m(e,t){for(;;){const s=Math.floor(Math.random()*e.length),a=Math.floor(1+Math.random()*t);yield new e[s](a)}}function u(e,t,s){const a=[];for(let i=0;i<s;i+=1)a.push(m(e,t).next().value);return new d(a)}class p{constructor(e,t){this.gamePlay=e,this.stateService=t,this.boardSize=this.gamePlay.boardSize,this.board=new Array(this.boardSize**2)}init(){this.newGame(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener((()=>this.newGame())),this.gamePlay.addSaveGameListener((()=>this.saveGame())),this.gamePlay.addLoadGameListener((()=>this.loadGame()))}newGame(){this.positionedCharacters=[],this.userSelected=null,this.computerSelected=null,this.notAllowedCell=null,this.points=0,this.level=1,this.getUserTeam(),this.getPcTeam(),this.gamePlay.drawUi(s[this.level]),this.gamePlay.redrawPositions(this.positionedCharacters),this.activePlayer="user",t.print()?this.maxPoints=t.print():this.maxPoints=this.points}saveGame(){this.stateService.save(t.from(this))}loadGame(){try{this.notAllowedCell=null;const{positionedCharacters:e,userSelected:a,computerSelected:i,points:r,level:h,activePlayer:c}=this.stateService.load();this.positionedCharacters=e,this.userSelected=a,this.computerSelected=i,this.points=r,this.level=h,this.activePlayer=c,this.gamePlay.drawUi(s[this.level]),this.gamePlay.redrawPositions(this.positionedCharacters),setTimeout((()=>{this.pcActions()}),1e3),this.maxPoints=t.print()}catch(t){throw e.showError("–ò–≥—Ä–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å, –ø—Ä–æ–¥–æ–ª–∂–∏–º –∏–≥—Ä—É"),new Error("Invalid state")}}static getRandomPosition(e){const t=Math.floor(Math.random()*e.length);return e.splice(t,1)[0]}getUserTeam(){const e=u([i,r,h],3,4),t=[];for(let e=0;e<this.board.length;e+=1)this.board[e]=e,e%this.boardSize!=0&&e%this.boardSize!=1||t.push(this.board[e]);e.characters.forEach((e=>{e.team="user";const s=p.getRandomPosition(t);this.containCharacter(s)||this.positionedCharacters.push(new n(e,s));const a=this.positionedCharacters[this.positionedCharacters.length-1];if(a.character.level>1)for(let e=1;e<a.character.level;e+=1)p.levelUp(a)}))}getPcTeam(){const e=u([c,o,l],3,4),t=[];for(let e=0;e<this.board.length;e+=1)this.board[e]=e,e%this.boardSize!=this.boardSize-2&&e%this.boardSize!=this.boardSize-1||t.push(this.board[e]);e.characters.forEach((e=>{e.team="pc";const s=p.getRandomPosition(t);this.containCharacter(s)||this.positionedCharacters.push(new n(e,s));const a=this.positionedCharacters[this.positionedCharacters.length-1];if(a.character.level>1)for(let e=1;e<a.character.level;e+=1)p.levelUp(a)}))}containCharacter(e){return!!this.positionedCharacters.find((t=>t.position===e))&&this.positionedCharacters.find((t=>t.position===e))}onCellEnter(e){var t;this.gamePlay.setCursor("auto"),this.containCharacter(e)&&(this.gamePlay.setCursor("pointer"),this.gamePlay.showCellTooltip(`üéñ ${(t=this.containCharacter(e).character).level} ‚öî ${t.attack} üõ° ${t.defence} ‚ù§ ${t.health}`,e)),this.userSelected&&(this.gamePlay.selectCell(this.userSelected.position),this.gamePlay.setCursor("not-allowed"),this.notAllowedCell=!0,this.possibleMoveArea(e,"user")&&e!==this.userSelected.position&&!this.hasEnemy(e)&&(this.gamePlay.selectCell(e,"green"),this.gamePlay.setCursor("pointer"),this.notAllowedCell=!1),this.possibleAttackArea(e,"user")&&this.hasEnemy(e)&&(this.gamePlay.selectCell(e,"red"),this.gamePlay.setCursor("crosshair"),this.notAllowedCell=!1),this.containCharacter(e)&&!this.hasEnemy(e)&&e!==this.userSelected.position&&(this.gamePlay.deselectCell(e),this.gamePlay.setCursor("pointer"),this.notAllowedCell=!1))}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.deselectCell(e)}async onCellClick(t){this.notAllowedCell&&e.showError("–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ"),"pc"===this.activePlayer&&(this.userSelected=null,this.gamePlay.deselectCell(t),e.showError("–î–æ–∂–¥–∏—Ç–µ—Å—å —Å–≤–æ–µ–≥–æ —Ö–æ–¥–∞")),this.containCharacter(t)&&"user"===this.containCharacter(t).character.team&&(this.computerSelected=null,this.userSelected?(this.gamePlay.deselectCell(this.userSelected.position),this.gamePlay.selectCell(t),this.userSelected=this.containCharacter(t)):(this.gamePlay.selectCell(t),this.userSelected=this.containCharacter(t))),this.userSelected||e.showError("–í—ã –¥–æ–ª–∂–Ω—ã –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂"),!this.userSelected||this.notAllowedCell||this.containCharacter(t)||(this.gamePlay.deselectCell(this.userSelected.position),this.userSelected.position=t,await this.gamePlay.redrawPositions(this.positionedCharacters),this.userSelected=null,this.activePlayer="pc",this.pcStep()),this.userSelected&&!this.notAllowedCell&&this.possibleAttackArea(t,"user")&&this.hasEnemy(t)&&(this.attack(t,"user"),await this.gamePlay.deselectCell(this.userSelected.position),this.userSelected=null,this.activePlayer="pc",this.pcStep())}pcStep(){"pc"===this.activePlayer&&(this.check("pc")?setTimeout((()=>{this.pcActions()}),1e3):setTimeout((()=>{this.newLevel()}),1e3))}newLevel(){this.level<4&&(this.level+=1,this.gamePlay.drawUi(s[this.level]),this.positionedCharacters.forEach((e=>{e.character.level+=1,p.levelUp(e)})),this.getPcTeam(),this.gamePlay.redrawPositions(this.positionedCharacters),this.pcStep()),4!==this.level||this.check("pc")||(e.showMessage(`–ü–æ–±–µ–¥–∞! –ù–∞–±—Ä–∞–Ω–æ –æ—á–∫–æ–≤: ${this.points}. –†–µ–∫–æ—Ä–¥: ${t.print()}. –ù–∞—á–Ω–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É `),this.newGame())}static levelUp(e){e.character.defence=Math.round(Math.max(e.character.defence,e.character.defence*(80+e.character.health)/100)),e.character.attack=Math.round(Math.max(e.character.attack,e.character.attack*(80+e.character.health)/100)),e.character.health<=20?e.character.health+=80:e.character.health=100}attack(e,s){let a=null;"user"===s?a=this.userSelected.character:"pc"===s&&(a=this.computerSelected.character);const i=this.containCharacter(e).character,r=Math.round(Math.max(a.attack-i.defence,.1*a.attack));if(i.health-=r,p.pcTeamMember(i)&&(this.points+=r),t.from(this),this.gamePlay.showDamage(e,r).then((()=>{this.gamePlay.redrawPositions(this.positionedCharacters)})),i.health<=0){const e=this.positionedCharacters.findIndex((e=>e.character.health===i.health));this.positionedCharacters.splice(e,1),this.gamePlay.redrawPositions(this.positionedCharacters)}}check(e){return!!this.positionedCharacters.find((t=>t.character.team===e))}static userTeamMember(e){return"user"===e.team}static pcTeamMember(e){return"pc"===e.team}hasEnemy(e){return!!(this.containCharacter(e)&&(this.userSelected&&p.userTeamMember(this.userSelected.character)&&p.pcTeamMember(this.containCharacter(e).character)||this.computerSelected&&p.pcTeamMember(this.computerSelected.character)&&p.userTeamMember(this.containCharacter(e).character)))}possibleMoveArea(e,t){let s=null,a=null;"user"===t?(s=this.userSelected.position,a=this.userSelected.character.distance):"pc"===t&&(s=this.computerSelected.position,a=this.computerSelected.character.distance);const i=e%this.boardSize,r=s%this.boardSize,h=Math.floor(e/this.boardSize),c=Math.floor(s/this.boardSize);return!this.containCharacter(e)&&(h===c&&Math.abs(e-s)<=a||i===r&&Math.abs(h-c)<=a||Math.abs(i-r)===Math.abs(h-c)&&Math.abs(i-r)<=a)}possibleAttackArea(e,t){let s=null,a=null;"user"===t?(s=this.userSelected.position,a=this.userSelected.character.attackRange):"pc"===t&&(s=this.computerSelected.position,a=this.computerSelected.character.attackRange);const i=e%this.boardSize,r=s%this.boardSize,h=Math.floor(e/this.boardSize),c=Math.floor(s/this.boardSize);return Math.abs(h-c)<=a&&Math.abs(i-r)<=a&&e!==s}canAttack(e){return!!this.possibleAttackArea(e,"pc")}static chooseStrongest(e){const t=[],s=[];e.forEach((e=>{const{attack:s}=e.character;t.push(s)}));const a=Math.max(...t);if(e.forEach((e=>{e.character.attack===a&&s.push(e)})),s.length>1){const e=Math.floor(Math.random()*s.length);return s[e]}return s[0]}pcActions(){const s=[],a=[],i=[],r=[],h=[],c=[];if(this.positionedCharacters.forEach((e=>{p.userTeamMember(e.character)?s.push(e.position):a.push(e.position)})),this.check("pc")&&"pc"===this.activePlayer){if(a.forEach((e=>{this.computerSelected=this.containCharacter(e);for(let t=0;t<s.length;t+=1)this.canAttack(s[t])?(r.push(this.containCharacter(e)),i.includes(s[t])||i.push(this.containCharacter(s[t]))):(h.includes(this.containCharacter(e))||h.push(this.containCharacter(e)),c.includes(this.containCharacter(s[t]))||c.push(this.containCharacter(s[t])))})),0===r.length&&this.computerSelected){this.computerSelected=p.chooseStrongest(h);const e=this.computerSelected.position%this.boardSize,t=Math.floor(this.computerSelected.position/this.boardSize),{distance:s}=this.computerSelected.character;let a=e-s;a<0&&(a=0);let i=e+s;i>this.boardSize-1&&(i=this.boardSize-1);let r=t+s;r>this.boardSize-1&&(r=this.boardSize-1);let o=t-s;o<0&&(o=0);const l=p.chooseStrongest(c),n=l.position%this.boardSize,d=Math.floor(l.position/this.boardSize),m=[];if(this.board.forEach((t=>{this.possibleMoveArea(t,"pc")&&(e>n&&t%this.boardSize===a&&m.push(t),e<n&&(i=n,t%this.boardSize===i&&m.push(t)),e===n&&t%this.boardSize===e&&m.push(t))})),d===t){const e=Math.floor(Math.random()*m.length);this.computerSelected.position=m[e]}d>t?this.computerSelected.position=Math.max(...m):d<t&&(this.computerSelected.position=Math.min(...m)),this.gamePlay.redrawPositions(this.positionedCharacters)}if(r.length>0){this.computerSelected=p.chooseStrongest(r);const e=p.chooseStrongest(i);this.attack(e.position,"pc")}}this.activePlayer="user",this.check("user")||(e.showMessage(`–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏! –ù–∞–±—Ä–∞–Ω–æ –æ—á–∫–æ–≤: ${this.points}. –†–µ–∫–æ—Ä–¥: ${t.print()}. –ù–∞—á–Ω–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É`),this.newGame())}}const C=new e;C.bindToDOM(document.querySelector("#game-container"));const S=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new p(C,S).init()}();